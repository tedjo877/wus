name: Hapus Semua Workers, Deployments, dan Pages

on:
  workflow_dispatch:

jobs:
  hapus-cloudflare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Hapus Semua Workers, Deployments, dan Pages
        run: |
          # === Konfigurasi ===
          API_TOKEN="${{ secrets.CF_API_TOKEN }}"
          ACCOUNT_ID="${{ secrets.CF_ACCOUNT_ID }}"
          CLOUDFLARE_API="https://api.cloudflare.com/client/v4"
          HEADER_AUTH="Authorization: Bearer $API_TOKEN"
          HEADER_CT="Content-Type: application/json"

          echo "Mulai proses penghapusan semua Workers, Deployments, dan Pages di Cloudflare..."
          echo

          # === Hapus Workers Routes ===
          echo "üìå Mengambil daftar Workers Routes..."
          ROUTES=$(curl -s -X GET "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/workers/filters" \
            -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.result[] | .id')

          if [ -z "$ROUTES" ]; then
            echo "‚úÖ Tidak ada Routes yang ditemukan."
          else
            echo "üö® Menghapus Routes..."
            for route in $ROUTES; do
              curl -s -X DELETE "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/workers/filters/$route" \
                -H "$HEADER_AUTH" -H "$HEADER_CT"
              echo "üóëÔ∏è Route '$route' dihapus."
            done
          fi

          # === Hapus Semua Workers ===
          echo "üìå Mengambil daftar Workers..."
          WORKERS=$(curl -s -X GET "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/workers/scripts" \
            -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.result[].id')

          if [ -z "$WORKERS" ]; then
            echo "‚úÖ Tidak ada Workers yang ditemukan."
          else
            echo "üö® Menghapus Workers..."
            for worker in $WORKERS; do
              curl -s -X DELETE "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/workers/scripts/$worker" \
                -H "$HEADER_AUTH" -H "$HEADER_CT"
              echo "üóëÔ∏è Worker '$worker' dihapus."
            done
          fi

          # === Hapus Semua Pages Projects (termasuk Deployment) ===
          echo
          echo "üìå Mengambil daftar Pages Projects..."
          PAGES=$(curl -s -X GET "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects" \
            -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.result[].name')

          if [ -z "$PAGES" ]; then
            echo "‚úÖ Tidak ada Pages Projects yang ditemukan."
          else
            echo "üö® Menghapus Pages Projects..."
            for project in $PAGES; do
              echo "üîç Memproses Project: $project"

              # === Hapus Semua Deployments ===
              echo "üìå Mengambil daftar Deployments untuk Project: $project..."
              DEPLOYMENTS=$(curl -s -X GET "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects/$project/deployments" \
                -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.result[].id')

              if [ -z "$DEPLOYMENTS" ]; then
                echo "‚úÖ Tidak ada Deployment untuk Project: $project."
              else
                echo "üö® Menghapus Semua Deployments untuk Project: $project..."
                for deployment in $DEPLOYMENTS; do
                  curl -s -X DELETE "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects/$project/deployments/$deployment" \
                    -H "$HEADER_AUTH" -H "$HEADER_CT"
                  echo "üóëÔ∏è Deployment '$deployment' dihapus dari Project: $project."
                done
              fi

              # === Hapus Pages Project ===
              echo "üóëÔ∏è Menghapus Project: $project..."
              curl -s -X DELETE "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects/$project" \
                -H "$HEADER_AUTH" -H "$HEADER_CT"
              
              # Konfirmasi Hapus
              STATUS=$(curl -s -X GET "$CLOUDFLARE_API/accounts/$ACCOUNT_ID/pages/projects/$project" \
                -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.success')

              if [ "$STATUS" == "false" ]; then
                echo "‚úÖ Project '$project' berhasil dihapus."
              else
                echo "‚ö†Ô∏è Gagal menghapus Project '$project'."
              fi

            done
          fi

          echo
          echo "üéâ Semua Workers, Deployments, dan Pages Projects berhasil diproses!"

