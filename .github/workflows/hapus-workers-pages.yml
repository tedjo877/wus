name: kfkgkgHapus Semua Workers, Deployments, dan Pages

on:
  workflow_dispatch:

jobs:
  hapus-cloudflare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Hapus Semua Workers, Deployments, dan Pages
        run: |
          # === Konfigurasi ===
          API_TOKEN="${{ secrets.CF_API_TOKEN }}"
          ACCOUNT_ID="${{ secrets.CF_ACCOUNT_ID }}"
          CLOUDFLARE_API="https://api.cloudflare.com/client/v4"
          HEADER_AUTH="Authorization: Bearer $API_TOKEN"
          HEADER_CT="Content-Type: application/json"

          echo "Mulai proses penghapusan semua Workers, Deployments, dan Pages di Cloudflare..."
          echo

          # === Ambil Zone ID ===
          echo "üìå Mengambil daftar Zone ID..."
          ZONES=$(curl -s -X GET "$CLOUDFLARE_API/zones" \
            -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.result[] | {id, name} | @base64')

          if [ -z "$ZONES" ]; then
            echo "‚úÖ Tidak ada Zone yang ditemukan."
          else
            echo "üîç Ditemukan $(echo "$ZONES" | wc -l) Zone(s)"
            for zone in $ZONES; do
              _jq() {
                echo "$zone" | base64 --decode | jq -r "$1"
              }
              ZONE_ID=$(_jq '.id')
              ZONE_NAME=$(_jq '.name')

              echo "üìå Memproses Zone: $ZONE_NAME ($ZONE_ID)"

              # === Hapus Workers Routes ===
              echo "üìå Mengambil daftar Workers Routes di Zone: $ZONE_NAME..."
              ROUTES=$(curl -s -X GET "$CLOUDFLARE_API/zones/$ZONE_ID/workers/routes" \
                -H "$HEADER_AUTH" -H "$HEADER_CT" | jq -r '.result[]?.id')

              if [ -z "$ROUTES" ] || [ "$ROUTES" = "null" ]; then
                echo "‚úÖ Tidak ada Routes yang ditemukan di Zone: $ZONE_NAME."
              else
                echo "üö® Menghapus Routes di Zone: $ZONE_NAME..."
                for route in $ROUTES; do
                  curl -s -X DELETE "$CLOUDFLARE_API/zones/$ZONE_ID/workers/routes/$route" \
                    -H "$HEADER_AUTH" -H "$HEADER_CT"
                  echo "üóëÔ∏è Route '$route' dihapus dari Zone: $ZONE_NAME."
                done
              fi
            done
          fi

          echo "‚úÖ Selesai memproses Workers Routes."
